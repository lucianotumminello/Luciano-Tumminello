
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Management System</title>
    <script>
      // Force disable service workers for admin path to prevent caching issues
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for (let registration of registrations) {
            registration.unregister();
            console.log('[CMS] Unregistered service worker');
          }
        });
      }
      
      // Clear cache for CMS resources
      if ('caches' in window) {
        caches.keys().then(function(cacheNames) {
          cacheNames.forEach(function(cacheName) {
            caches.delete(cacheName);
            console.log('[CMS] Cleared cache:', cacheName);
          });
        });
      }
    </script>
    <!-- Make sure config is loaded with the correct MIME type -->
    <link href="/admin/config.yml" type="text/yaml" rel="cms-config-url" />
    <!-- Load config validator first -->
    <script src="/admin/config-loader.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .error-message {
        color: #e53e3e;
        padding: 1rem;
        border: 1px solid #fed7d7;
        border-radius: 0.25rem;
        background-color: #fff5f5;
        margin: 2rem;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
      .loading-message {
        text-align: center;
        margin-top: 4rem;
      }
      .retry-button {
        background-color: #3182ce;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        border: none;
        font-size: 0.875rem;
        cursor: pointer;
        margin-top: 1rem;
        margin-right: 0.5rem;
      }
      .retry-button:hover {
        background-color: #2c5282;
      }
      .debug-info {
        margin-top: 2rem;
        font-size: 0.75rem;
        color: #718096;
        text-align: left;
        padding: 1rem;
        background-color: #f7fafc;
        border-radius: 0.25rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        display: none;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3182ce;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #cms-load-timeout {
        display: none;
        margin-top: 2rem;
        padding: 1rem;
        background-color: #fffaf0;
        border: 1px solid #feebc8;
        border-radius: 0.25rem;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div id="nc-root">
      <div class="loading-message">
        <div class="loader"></div>
        <p>Loading CMS...</p>
      </div>
    </div>
    <div id="cms-load-timeout">
      <h3>CMS is taking longer than expected</h3>
      <p>Try one of these options:</p>
      <button onclick="forceReload()" class="retry-button">Force Reload</button>
      <button onclick="tryBackupCMS()" class="retry-button">Try Backup CMS</button>
      <button onclick="window.location.href = '/'" class="retry-button">Return to Site</button>
    </div>
    <div id="debug-info" class="debug-info"></div>
    <script>
      // Function to log to the debug panel and console
      function logDebug(message) {
        console.log('[CMS]', message);
        const debugEl = document.getElementById('debug-info');
        if (debugEl) {
          debugEl.style.display = 'block';
          const logLine = document.createElement('div');
          logLine.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
          debugEl.appendChild(logLine);
        }
      }
      
      // Show URL parameters for debugging
      const urlParams = new URLSearchParams(window.location.search);
      const paramDebug = Array.from(urlParams).map(([key, value]) => `${key}: ${value}`).join(', ');
      logDebug(`Page loaded with params: ${paramDebug || 'none'}`);
      
      // Show debug panel in development or when requested
      if (window.location.hostname === 'localhost' || 
          window.location.hostname === '127.0.0.1' || 
          urlParams.has('debug')) {
        document.getElementById('debug-info').style.display = 'block';
      }
      
      // Show backup options if loading takes too long
      setTimeout(() => {
        const cms = window.CMS;
        if (!cms) {
          document.getElementById('cms-load-timeout').style.display = 'block';
        }
      }, 15000);
      
      // Force reload function for backup option
      function forceReload() {
        logDebug('Force reloading page and clearing cache');
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => caches.delete(cacheName));
            window.location.href = `/admin/index.html?forcereload=true&t=${Date.now()}`;
          });
        } else {
          window.location.href = `/admin/index.html?forcereload=true&t=${Date.now()}`;
        }
      }
      
      // Try backup CMS function
      function tryBackupCMS() {
        logDebug('Loading backup CMS version');
        loadBackupCMS();
      }
      
      // Global error handling
      window.addEventListener('error', function(event) {
        logDebug(`Error: ${event.message}`);
        const rootEl = document.getElementById('nc-root');
        if (rootEl) {
          rootEl.innerHTML = `
            <div class="error-message">
              <h3>CMS Error</h3>
              <p>There was a problem loading the CMS. Please check your configuration and try again.</p>
              <p>Error details: ${event.message}</p>
              <button class="retry-button" onclick="forceReload()">Try Again</button>
              <button class="retry-button" onclick="tryBackupCMS()">Try Backup CMS</button>
              <button class="retry-button" onclick="window.location.href = '/'">Return to Site</button>
              <button class="retry-button" onclick="toggleDebug()">Show Debug Info</button>
            </div>
          `;
        }
      });
      
      function toggleDebug() {
        const debugEl = document.getElementById('debug-info');
        if (debugEl) {
          debugEl.style.display = debugEl.style.display === 'block' ? 'none' : 'block';
        }
      }
      
      // Initialize Netlify Identity for authentication
      const loadIdentity = () => {
        logDebug('Starting Netlify Identity loading');
        return new Promise((resolve, reject) => {
          // Check if already loaded
          if (window.netlifyIdentity) {
            logDebug('Netlify Identity already loaded');
            resolve(window.netlifyIdentity);
            return;
          }
          
          const script = document.createElement('script');
          script.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
          script.async = true;
          
          script.onerror = () => {
            const error = 'Failed to load Netlify Identity widget';
            logDebug(error);
            reject(new Error(error));
            
            const rootEl = document.getElementById('nc-root');
            if (rootEl) {
              rootEl.innerHTML = `
                <div class="error-message">
                  <h3>Authentication Error</h3>
                  <p>Failed to load authentication system. Please check your internet connection.</p>
                  <button class="retry-button" onclick="forceReload()">Try Again</button>
                  <button class="retry-button" onclick="window.location.href = '/'">Return to Site</button>
                </div>
              `;
            }
          };
          
          script.onload = () => {
            logDebug('Netlify Identity loaded');
            if (window.netlifyIdentity) {
              window.netlifyIdentity.on('init', user => {
                logDebug('Netlify Identity initialized' + (user ? ' with user' : ' without user'));
                resolve(window.netlifyIdentity);
                
                // Setup login event handling
                if (!user) {
                  window.netlifyIdentity.on('login', () => {
                    logDebug('User logged in, reloading admin');
                    // Use a slight delay to ensure everything is ready
                    setTimeout(() => {
                      document.location.href = '/admin/?login=success';
                    }, 300);
                  });
                }
              });
            } else {
              reject(new Error('Netlify Identity not available after loading'));
            }
          };
          
          document.head.appendChild(script);
        });
      };
      
      // Load Decap CMS with retry
      const initCMS = (retryCount = 0) => {
        logDebug(`Initializing Decap CMS (attempt: ${retryCount + 1})`);
        
        return new Promise((resolve, reject) => {
          if (retryCount >= 3) {
            reject(new Error('Failed to load Decap CMS after multiple attempts'));
            return;
          }
          
          // Make sure we're using the correct script URL and version
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
          script.async = true;
          
          script.onerror = () => {
            logDebug(`Failed to load Decap CMS on attempt ${retryCount + 1}, retrying...`);
            
            setTimeout(() => {
              initCMS(retryCount + 1).then(resolve).catch(reject);
            }, 1000);
          };
          
          script.onload = () => {
            logDebug('Decap CMS script loaded successfully');
            
            // Additional check to see if CMS was properly initialized
            setTimeout(() => {
              if (window.CMS) {
                logDebug('CMS object successfully initialized');
                resolve(true);
              } else {
                logDebug('CMS object not found after script load, trying again...');
                if (retryCount < 3) {
                  initCMS(retryCount + 1).then(resolve).catch(reject);
                } else {
                  reject(new Error('CMS failed to initialize after multiple attempts'));
                }
              }
            }, 1000);
          };
          
          document.body.appendChild(script);
        });
      };
      
      // Load backup script if standard loading fails
      const loadBackupCMS = () => {
        logDebug('Attempting to load CMS from backup CDN');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/decap-cms@^3.0.0/dist/decap-cms.js';
        script.async = true;
        
        script.onload = () => {
          logDebug('Backup CMS script loaded');
        };
        
        script.onerror = () => {
          logDebug('Even backup CMS failed to load');
          const rootEl = document.getElementById('nc-root');
          if (rootEl) {
            rootEl.innerHTML = `
              <div class="error-message">
                <h3>Critical CMS Error</h3>
                <p>Unable to load the CMS from multiple sources. Please check your network connection and try again.</p>
                <button class="retry-button" onclick="forceReload()">Try Again</button>
                <button class="retry-button" onclick="window.location.href = '/'">Return to Site</button>
              </div>
            `;
          }
        };
        
        document.body.appendChild(script);
      };
      
      // Main initialization function with error handling
      const initialize = async () => {
        try {
          logDebug('Starting CMS initialization');
          
          // Step 1: Initialize Netlify Identity
          await loadIdentity();
          
          // Step 2: Initialize Decap CMS
          await initCMS();
          
          logDebug('CMS initialization complete');
        } catch (err) {
          logDebug(`CMS initialization failed: ${err.message}. Trying backup method...`);
          
          // Try backup loading method
          loadBackupCMS();
          
          const rootEl = document.getElementById('nc-root');
          if (rootEl) {
            rootEl.innerHTML = `
              <div class="error-message">
                <h3>CMS Loading Error</h3>
                <p>Failed to load the content management system. Attempting backup method...</p>
                <p>Error details: ${err.message}</p>
                <button class="retry-button" onclick="forceReload()">Try Again</button>
                <button class="retry-button" onclick="tryBackupCMS()">Try Backup CMS</button>
                <button class="retry-button" onclick="window.location.href = '/'">Return to Site</button>
                <button class="retry-button" onclick="toggleDebug()">Show Debug Info</button>
              </div>
            `;
          }
        }
      };
      
      // Start initialization when DOM is loaded
      document.addEventListener('DOMContentLoaded', () => {
        logDebug('DOM loaded, starting initialization');
        initialize();
      });
      
      // Failsafe if DOMContentLoaded already fired
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        logDebug('DOM already loaded, starting initialization immediately');
        setTimeout(() => initialize(), 100);
      }
    </script>
  </body>
</html>
